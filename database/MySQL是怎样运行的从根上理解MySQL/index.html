<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>3 第3章 乱码的前世今生-字符集和比较规则 - PegasusWang的读书笔记</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "3 \u7b2c3\u7ae0 \u4e71\u7801\u7684\u524d\u4e16\u4eca\u751f-\u5b57\u7b26\u96c6\u548c\u6bd4\u8f83\u89c4\u5219";
    var mkdocs_page_input_path = "database/MySQL\u662f\u600e\u6837\u8fd0\u884c\u7684\u4ece\u6839\u4e0a\u7406\u89e3MySQL.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> PegasusWang的读书笔记</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">简介</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">代码</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../code/work_with_legacy_code/">《Work with legacy code》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../code/代码大全/">《代码大全》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../code/代码的未来/">《代码的未来》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../code/基本功/">《基本功》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../code/敏捷技能修炼/">《敏捷技能修炼》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../code/程序员应该知道的97件事/">《程序员应该知道的97件事》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../code/编写可读代码的艺术/">《编写可读代码的艺术》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../code/编程匠艺/">《编程匠艺》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../code/领域驱动设计/">《领域驱动设计》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">调试技术</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../debug/软件调试修炼之道/book/">《软件调试修炼之道》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../debug/Effective_Debugging/">《Effective Debugging》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">数据库</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../getting_started_with_impala/">《Getting started with impala》</a>
                </li>
                <li class="">
                    
    <a class="" href="../mysql必知必会/">《mysql必知必会》</a>
                </li>
                <li class="">
                    
    <a class="" href="../mysql性能调优与架构实践/">《mysql性能调优与架构实践》</a>
                </li>
                <li class="">
                    
    <a class="" href="../Mysql技术内幕InnoDB存储引擎/">《Mysql技术内幕InnoDB存储引擎》</a>
                </li>
                <li class="">
                    
    <a class="" href="../redis实战/">《Redis实战》</a>
                </li>
                <li class="">
                    
    <a class="" href="../redis深度历险核心原理和应用实践/book/">《Redis深度历险核心原理和应用实践》</a>
                </li>
                <li class="">
                    
    <a class="" href="../redis设计与实现/">《redis设计与实现》</a>
                </li>
                <li class="">
                    
    <a class="" href="../七周七数据库/">《七周七数据库》</a>
                </li>
                <li class="">
                    
    <a class="" href="../深入浅出mysql/">《深入浅出mysql》</a>
                </li>
                <li class="">
                    
    <a class="" href="../高性能mysql第三版/">《高性能mysql第三版》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">前端</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../frontend/CSS_The_Missing_Manual/">《CSS_The_Missing_Manual》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../frontend/reactjs_小书/">《reactjs小书》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../frontend/es6标准入门/">《ES6标准入门》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">golang</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../golang/1_the_go_programming_lauguage/">《1 The Go Programming Language》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/2_the_go_programming_lauguage/">《2 The Go Programming Language》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/3_the_go_programming_lauguage/">《3 The Go Programming Language》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/build-web-application-with-golang/">《Build Web Application With Golang》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/go101/book/">《Go101》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/network-programming-with-go/book/">《Network Programming with go》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/building-microservices-with-go/book/">《Building Microservices With Go》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/building_restful_web_services_with_go/book/">《Building Restful Web Services with Go》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/concurrency-in-go/concurrency_in_go/">《Concurrency In Go》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/go_in_action(go语言实战)/">《Go In Action(Go 实战)》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/go语言学习笔记语言详解/">《Go学习笔记语言详解》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/go语言学习笔记源码剖析/">《Go学习笔记源码剖析》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/go语言编程/">《Go语言编程》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../golang/go语言编程之旅.md">《Go语言编程之旅》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">java</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../java/java-basic-introduction/">《java basic introduction》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">网络</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../network/tcp_ip详解卷一/tcp_ip详解卷一/">《TCP IP详解卷一》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">心理学</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../psychology/一切都是童年的错吗/">《一切都是童年的错吗》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../psychology/亲密关系/">《亲密关系》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../psychology/情商/">《情商》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../psychology/拖延心理学/">《拖延心理学》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../psychology/积极心理学/">《积极心理学》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../psychology/自控力/">《自控力》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../psychology/自控力-和压力做朋友/">《自控力:和压力做朋友》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../psychology/活出最乐观的自己/">《活出最乐观的自己》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../psychology/改变心理学的40项研究/">《改变心理学的40项研究》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../psychology/超越自卑/">《超越自卑》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../psychology/反脆弱/">《反脆弱》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">python</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../python/fluent_python/">《Fluent Python》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../python/Python_Microservices_Development/">《Python Microservices Development》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../python/high_performance_python/">《High Performance Python》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../python/python_网络编程/">《Python网络编程》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">创业</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../startup/hello_startup/">《Hello Startup》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../startup/斯坦福公开课-如何创业/">《斯坦福公开课如何创业》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../startup/运营其实很简单/">《运营其实很简单》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">unix/linux</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../unix_linux/Linux高性能服务器编程/Linux高性能服务器编程/">《Linux高性能服务器编程》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../unix_linux/unix编程艺术/">《unix编程艺术》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../unix_linux/unix网络编程卷一/">《unix网络编程卷一》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">分布式</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../分布式/Kafka权威指南/">《Kafka 权威指南》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../分布式/分布式框架原理与应用/">《分布式框架原理与应用》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../分布式/大规模分布式存储系统/">《大规模分布式存储系统》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../分布式/深入分布式缓存从原理到实践/">《深入分布式缓存从原理到实践》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../分布式/深入理解Kafka核心设计与实践原理/深入理解Kafka核心设计与实践原理/">《深入理解Kafka核心技术与实践原理》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">搜索引擎</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../搜索引擎/Elasticsearch实战/book/">《Elasticsearch实战》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">开发工具</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../开发工具/practical_vim/practical_vim/">《Practical Vim》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../开发工具/vim8文本处理实战/vim8文本处理实战/">《Vim8文本处理实战》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../开发工具/learn_vim_the_hard_way/">《Learn vim scrpt the hard way》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../开发工具/pro_git/">《Pro Git》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../开发工具/Mastering_vim/">《Mastering Vim》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../开发工具/mastering_vim_quickly/">《Mastering Vim Quickly》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">思维</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../思维认知/专注力_化繁为简的惊人力量/">《专注力》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../思维认知/为什么精英这样用脑不会累/">《为什么精英这样用脑不会累》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../思维认知/刻意练习/">《刻意练习》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../思维认知/如何想到又做到/">《如何想到又做到》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../思维认知/学习之道/">《学习之道》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../思维认知/学习力/">《学习力》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../思维认知/批判性思维工具/">《批判性思维工具》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../思维认知/程序员的思维修炼(开发认知潜能的九堂课)/">《程序员的思维修炼》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../思维认知/认知天性/">《认知天性》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../思维认知/超效率手册/">《超效率手册》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../思维认知/高效程序员的45个习惯/">《高效程序员的45个习惯》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">源码</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../源码阅读_sourcecode/">《源码阅读》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">网站架构微服务</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../网站架构微服务/microservices_patterns_微服务架构设计模式/book/">《微服务架构设计模式》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../网站架构微服务/从0开始学架构/从0开始学架构/">《从0开始学架构》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../网站架构微服务/web_scalavility_for_startup_engineers/">《web scalavility for startup engineers》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../网站架构微服务/design_data_instensive_application/">《design_data_instensive_application》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../网站架构微服务/clean_architecture/">《clean_architecture》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../网站架构微服务/微服务实战/">《微服务实战》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../网站架构微服务/微服务设计/">《微服务设计》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">软件工程/项目管理</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../软件工程_项目管理/人月神话/">《人月神话》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../软件工程_项目管理/代码之殇/">《代码之殇》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../软件工程_项目管理/解析极限编程-拥抱变化/">《解析极限编程》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../软件工程_项目管理/构建之法:现代软件工程/">《构建之法:现代软件工程》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../软件工程_项目管理/项目管理修炼之道/">《项目管理修炼之道》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">运维</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../运维/linux集群和自动化运维/">《linux集群和自动化运维》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../运维/python自动化运维/">《python自动化运维》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">金融理财</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../金融理财/迈出投资第一步/迈出投资第一步/">《迈出投资第一步》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../金融理财/定投十年/">《定投十年》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../金融理财/指数基金投资日志/">《指数基金投资日志》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../金融理财/穷查理宝典/">《穷查理宝典》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../金融理财/聪明的定投/">《聪明的定投》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">写作</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../写作/刷屏文案写作技巧/">《刷屏文案写作技巧》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">互联网</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../互联网/我的互联网方法论-周鸿祎/">《我的互联网方法论-周鸿祎》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../互联网/用户思维/">《用户思维》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">区块链</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../区块链/区块链技术指南(blockchain_guide)/">《区块链技术指南》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">技术演讲</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../lecture/Gopher/哔哩哔哩的go微服务实战/note/">《哔哩哔哩的go微服务实战》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../lecture/Gopher/Go_Error/go业务基础库之Error&Context/">《go业务基础库之Error&Context》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../lecture/Gopher/Go同步和并发设计模式/note/">《Go同步和并发设计模式》</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">职场</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../career/give_and_take/">《give and take》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/the_effective_engineer/">《the_effective_engineer》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/光速成长/">《光速成长》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/向上管理/">《向上管理》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/成功动机与目标/">《成功动机与目标》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/番茄工作法/">《番茄工作法》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/聆听沟通学/">《聆听沟通学》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/知乎职人觉醒/">《知乎职人觉醒》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/知识变现/">《知识变现》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/聆听沟通学/">《聆听沟通学》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/职场动物进化手册/">《职场动物进化手册》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/职场解释系/">《职场解释系》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/请停止无效努力/">《请停止无效努力》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/软技能/">《软技能》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/高效15法则/">《高效15法则》</a>
                </li>
                <li class="">
                    
    <a class="" href="../../career/高效清单工作法/">《高效清单工作法》</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">PegasusWang的读书笔记</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>3 第3章 乱码的前世今生-字符集和比较规则</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="3-3-">3 第3章 乱码的前世今生-字符集和比较规则</h1>
<p>(看书的时候把书中的 mysql 命令找一个测试的 mysql 自己尝试一下)</p>
<ul>
<li>utf8mb3 :阉割过的 utf8 字符集，只使用1~3个字节表示字符。 (mysql中 utf8 就是 utf8mb3 的别名)</li>
<li>utf8mb4 :正宗的 utf8 字符集，使用1~4个字节表示字符。 (如果有 emoji 要用utf8mb4)</li>
</ul>
<p>字符集(CHARSET)与比较规则(COLLATION)：</p>
<ul>
<li>只修改字符集，则比较规则将变为修改后的字符集默认的比较规则。</li>
<li>只修改比较规则，则字符集将变为修改后的比较规则对应的字符集。(比如要修改大小写排序敏感等)</li>
</ul>
<p>我们通常都把 character_set_client 、character_set_connection、 character_set_results 这三个系统变量设置成和客户端使用的字符集一致的情况，
这样减少了很多无谓的字符 集转换。为了方便我们设置， MySQL 提供了一条非常简便的语句: <code>SET NAMES 字符集名</code>;</p>
<p>这一条语句产生的效果和我们执行这3条的效果是一样的:</p>
<pre><code>SET character_set_client = 字符集名;
SET character_set_connection = 字符集名;
SET character_set_results = 字符集名;
</code></pre>
<h1 id="4-4-innodb">4 第4章 从一条记录说起-InnoDB记录结构</h1>
<p>页: InnoDB将数据划分为若干个页，以页作为磁盘和内存之间交互的基本单位，InnoDB中页的大小 一般为 16 KB。
也就是在一般情况下，一次最少从磁盘中读取16KB的内容到内存中，一次最少把内存中的16KB 内容刷新到磁盘中。</p>
<p>行格式： Compact 、 Redundant 、Dynamic 和 Compressed 行格式</p>
<h3 id="432-compact">4.3.2 Compact 行格式：</h3>
<p><code>|变长字段长度列表|NULL值列表|记录头信息|列1的值|列2的值|...|列n的值|</code></p>
<p>MySQL 会为每个记录默认的添加一些列(也称为 隐藏列 ), DB_ROW_ID(没有定义主键和unique键会添加), DB_TRX_ID(事务ID), DB_ROLL_PTR(回滚指针)</p>
<p>对于 CHAR(M) 类型的列来说，当列采用的是定长字符集时，该列占用的字节数不会被加到变长字 段长度列表，而如果采用变长字符集时，该列占用的字节数也会被加到变长字段长度列表。</p>
<h3 id="433-redundant">4.3.3 Redundant 行格式</h3>
<p><code>|字段长度偏移列表|记录头信息|列1的值|列2的值|...|列n的值|</code></p>
<h3 id="434">4.3.4 行溢出数据</h3>
<p>MySQL 是以 页 为基本单位来管理存储空间的，我们 的记录都会被分配到某个 页 中存储。而一个页的大小一般是 16KB ，
也就是 16384 字节，而一个 VARCHAR(M) 类 型的列就最多可以存储 65532 个字节，这样就可能造成一个页存放不了一条记录的尴尬情况。</p>
<p>4.3.5 Dynamic和Compressed行格式
Dynamic 和 Compressed 行格式 MySQL 版本是 5.7 ，它的默认行格 式就是 Dynamic ，这俩行格式和 Compact 行格式挺像，
只不过在处理 行溢出 数据时有点儿分歧，它们不会在记录的真实数据处存储字段真实数据的前 768 个字节，而是把所有的字节都存储到其他页面中，
只在记录的真实数 据处存储其他页面的地址。</p>
<p>Compressed 行格式和 Dynamic 不同的一点是， Compressed 行格式会采用压缩算法对页面进行压缩，以节省空 间。</p>
<h1 id="5-5-innodb">5 第5章 盛放记录的大盒子-InnoDB数据页结构</h1>
<h2 id="52">5.2 数据页结构的快速浏览</h2>
<p>数据页代表的这块 16KB 大小的存储空间可以被划分为多个部分，不同部分有不同的功能，InnoB数据页结构示意图：</p>
<p><code>|File Header(38字节)|Page Header(56字节)|Infimum + supremum(26字节)|User Records(大小不定)|Free Space(大小不定)|Page Directory(大小不定)|File Tailer(8字节)|</code></p>
<h2 id="53">5.3 记录在页中的存储</h2>
<p>在一开 始生成页的时候，其实并没有 User Records 这个部分，每当我们插入一条记录，都会从 Free Space 部分，
也就是尚未使用的存储空间中申请一个记录大小的空间划分到 User Records 部分，当 Free Space 部分的空间全部 被 User Records 部分替代掉之后，也就意味着这个页使用完了，如果还有新的记录插入的话，就需要去申请新 的页了</p>
<p>不论我们怎么对页中的记录做增删改操作，InnoDB始终会维护一条记录的单链表，链表中的各个 节点是按照主键值由小到大的顺序连接起来的</p>
<h2 id="54-page-directory">5.4 Page Directory (页目录)</h2>
<p>所以在一个数据页中查找指定主键值的记录的过程分为两步:
1. 通过二分法确定该记录所在的槽，并找到该槽中主键值最小的那条记录。
2. 通过记录的 next_record 属性遍历该槽所在的组中的各个记录。</p>
<h2 id="55-page-header">5.5 Page Header (页面头部)</h2>
<p>为了能得到一个数据页中存储的记录的状态信息，比如本页中已经存储了多少条记录，第 一条记录的地址是什么，
页目录中存储了多少个槽等等，特意在页中定义了一个叫 Page Header 的部分，它是页结构的第二部分，
这个部分占用固定的 56 个字节，专门存储各种状态信息</p>
<h2 id="56-file-header">5.6 File Header(文件头部)</h2>
<p>File Header 针对各种类型的页都通用，也就是说不同类型的页都会以 File Header 作 为第一个组成部分，
它描述了一些针对各种页都通用的一些信息，比方说这个页的编号是多少，它的上一个页、 下一个页是谁, 这个部分占用固定的 38 个字节</p>
<h2 id="57-file-trailer">5.7 File Trailer</h2>
<p>InnoDB 存储引擎会把数据存储到磁盘上，但是磁盘速度太慢，需要以 页 为单位把数据加载到内存中处理，
如果该页中的数据在内存中被修改了，那么在修改后的某个时间需要把数据同步到磁盘中。但是在同步了一半的时候中断电了咋办，
为了检测一个页是否完整(也就是在同步的时候有没有发生只同步 一半的尴尬情况)，InnoDB 每个页的尾部都加了一个 File Trailer 部分，
这个部分由 8 个字 节组成，可以分成2个小部分: 前4个字节代表页的校验和, 后4个字节代表页面被最后修改时对应的日志序列位置(LSN)。</p>
<h1 id="6-6-b">6 第6章 快速查询的秘籍-B+树索引</h1>
<h2 id="62">6.2 索引</h2>
<p>页分裂：下一个数据页中用户记录的主键值必须大于上一个页中用户记录的主键值。如果不满足就需要先移动再插入，
这个过程我们也可以称为 页分裂 。</p>
<p>目录项记录和普通用户记录的区别：(一个存储 主键和页号，一个存用户插入数据)</p>
<ul>
<li>目录项记录 的 record_type 值是1，而普通用户记录的 record_type 值是0。</li>
<li>目录项记录 只有主键值和页的编号两个列，而普通的用户记录的列是用户自己定义的，可能包含很多列， 另外还有 InnoDB 自己添加的隐藏列。</li>
<li>只有在存储 目录项记录 的页 中的主键值最小的 目录项记录 的 min_rec_mask 值为 1 ，其他别的记录的 min_rec_mask 值都是 0 。</li>
</ul>
<p>不论是存放用户记录的数据页，还是存放目录项记录的数据页，我们都把它们存放到 B+ 树这个数据结构中了， 所以我们也称这些数据页为 节点 。
从图中可以看出来，我们的实际用户记录其实都存放在B+树的最底层的节点 上，这些节点也被称为 叶子节点 或 叶节点 ，
其余用来存放 目录项 的节点称为 非叶子节点 或者 内节点 ，其 中 B+ 树最上边的那个节点也称为 根节点 。</p>
<h4 id="6221">6.2.2.1 聚簇索引</h4>
<p>上边介绍的 B+ 树本身就是一个目录，或者说本身就是一个索引。它有两个特点:
1. 使用记录主键值的大小进行记录和页的排序，这包括三个方面的含义:
    - 页内的记录是按照主键的大小顺序排成一个单向链表。
    - 各个存放用户记录的页也是根据页中用户记录的主键大小顺序排成一个双向链表。
    - 存放目录项记录的页分为不同的层次，在同一层次中的页也是根据页中目录项记录的主键大小顺序排成
    一个双向链表。
2. B+ 树的叶子节点存储的是完整的用户记录。 所谓完整的用户记录，就是指这个记录中存储了所有列的值(包括隐藏列)。</p>
<p>具有这两种特性的 B+ 树称为 聚簇索引 ，所有完整的用户记录都存放在这个 聚簇索引 的叶子节点处
InnoDB 存储引擎会自动的为我们创建聚簇索引。另外有趣的一点是，在 InnoDB 存储引擎中， 聚簇索引 就是数 据的存储方式(所有的用户记录都存储在了 叶子节点 )，
也就是所谓的索引即数据，数据即索引。</p>
<h4 id="6222">6.2.2.2 二级索引</h4>
<p>非聚簇索引(二级索引or辅助索引)：B+ 数叶子节点只存储了当前列和主键(索引列和主键)，还需要再去聚簇索引中再查找一遍完整的用户记录。(这个过程也叫做回表)</p>
<p>联合索引：以多个列的大小为排序规则建立的B+树称为联合索引，本质上也是一个二级索引 (一个B+树)</p>
<h3 id="623-innodbb">6.2.3 InnoDB的B+树索引的注意事项</h3>
<ul>
<li>根节点不动</li>
</ul>
<p>一个B+树索引的根节点自诞生之日起，便不会再移动。这样只要我们对某个表 建立一个索引，那么它的 根节点 的页号便会被记录到某个地方，
然后凡是 InnoDB 存储引擎需要用到这个索引的 时候，都会从那个固定的地方取出 根节点 的页号，从而来访问这个索引。</p>
<ul>
<li>内节点中目录项记录的唯一性</li>
<li>一个页面最少存储2条记录</li>
</ul>
<h3 id="624-myisam">6.2.4 MyISAM中的索引方案简单介绍</h3>
<ul>
<li>MyISAM 的索引方案虽然也使用树形 结构，但是却将索引和数据分开存储:
将表中的记录按照记录的插入顺序单独存储在一个文件中，称之为 数据文件 。这个文件并不划分为若干个 数据页，有多少记录就往这个文件中塞多少记录就成了。我们可以通过行号而快速访问到一条记录</li>
<li>使用 MyISAM 存储引擎的表会把索引信息另外存储到一个称为 索引文件 的另一个文件中。
MyISAM 会单独为 表的主键创建一个索引，只不过在索引的叶子节点中存储的不是完整的用户记录，而是 主键值 + 行号 的组 合。也就是先通过索引找到对应的行号，再通过行号去找对应的记录!(全部是二级索引)</li>
<li>如果有需要的话，我们也可以对其它的列分别建立索引或者建立联合索引，原理和 InnoDB 中的索引差不 多，不过在叶子节点处存储的是 相应的列 + 行号 。这些索引也全部都是 二级索引</li>
</ul>
<h3 id="625-mysql">6.2.5 MySQL中创建和删除索引的语句</h3>
<p>InnoDB 和 MyISAM 会自动为主键或 者声明为 UNIQUE 的列去自动建立 B+ 树索引，但是如果我们想为其他的列建立索引就需要我们显式的去指明。</p>
<h1 id="7-7-b">7 第7章 好东西也得先学会怎么用-B+树索引的使用</h1>
<h2 id="71">7.1 索引的代价</h2>
<ul>
<li>空间。每建立一个索引都要为它建立一棵 B+ 树，每一棵 B+ 树的每一个节点都是一个数据页， 一个页默认会占用 16KB 的存储空间，一棵很大的 B+ 树由许多数据页组成</li>
<li>时间。每次对表中的数据进行增、删、改操作时，都需要去修改各个 B+ 树索引</li>
</ul>
<h2 id="72-b">7.2 B+树索引适用的条件</h2>
<pre><code>-- 以下使用这个表作为示例
CREATE TABLE person_info(
        id INT NOT NULL auto_increment,
        name VARCHAR(100) NOT NULL,
        birthday DATE NOT NULL,
        phone_number CHAR(11) NOT NULL,
        country varchar(100) NOT NULL,
        PRIMARY KEY (id),
        KEY idx_name_birthday_phone_number (name, birthday, phone_number)
);
</code></pre>
<ul>
<li>全值匹配：搜索条件中的列和索引列一致的话，这种情况就称为全值匹配。
<code>SELECT * FROM person_info WHERE name = 'Ashburn' AND birthday = '1990-09-27' AND phone_num ber = '15123983239';</code>
这几个条件的书写顺序无影响，查询优化器会根据索引顺序决定先使用那个搜索条件。</li>
</ul>
<ul>
<li>匹配左边的列(最左前缀)。如果我们想使用联合索引中尽可能多的列，搜索条件中的各个列必须是联合索引中 从最左边连续的列
因为 B+ 树的数据页和记录先是按照 name 列的值排序的，在 name 列的值相同的情况下才使 用 birthday 列进行排序(上述 sql 例子)。</li>
</ul>
<ul>
<li>匹配列前缀。 <code>SELECT * FROM person_info WHERE name LIKE 'As%';</code> 可以使用索引，而 <code>LIKE %As%</code> 会全表扫描</li>
</ul>
<ul>
<li>匹配值范围。B+树所有记录都是按照索引列的值从小到大的顺序排好序的。
    - <code>SELECT * FROM person_info WHERE name &gt; 'Asa' AND name &lt; 'Barlow'</code>; 可以使用索引，因为排好序了找到首位记录，
    中间链表连起来的都可以取出来，之后找到记录的主键回表查找完整记录。
    - 如果对多个列同时进行范围查找的话，只有对索引最左边的那个 列进行范围查找的时候才能用到 B+ 树索引。
    <code>SELECT * FROM person_info WHERE name &gt; 'Asa' AND name &lt; 'Barlow' AND birthday &gt; '1980-01-01'</code> 只能用到 name 索引</li>
</ul>
<ul>
<li>精确匹配某一列并范围匹配另外一列。对于同一个联合索引来说，虽然对多个列都进行范围查找时只能用到最左边那个索引列，但是如果左边的列是精
确查找，则右边的列可以进行范围查找
    - <code>SELECT * FROM person_info WHERE name = 'Ashburn' AND birthday &gt; '1980-01-01' AND birthday &lt; '2000-12-31' AND phone_number &gt; '15100000000';</code>
    - 上面 sql name 和 birthday 可以用到索引，但是 phone_number 条件不行</li>
</ul>
<ul>
<li>用于排序。
    - ORDER BY 子句里使用到了我们的 索引列，就有可能省去在内存或文件中排序的步骤。<code>SELECT * FROM person_info ORDER BY name, birthday, phone_number LIMIT 10;</code>
    - 使用联合索引排序注意：ORDER BY 的子句后边的列的顺序也必须按照索引列的顺序给出
    - 不可以使用索引排序的几种情况：
        - ASC, DESC 混用
        - WHERE 子句中出现非排序使用到的索引列
        - 排序列包含非同一个索引的列。<code>SELECT * FROM person_info ORDER BY name, country LIMIT 10;</code> country 不在索引列
        - 排序列使用了复杂表达式</li>
</ul>
<ul>
<li>用户分组。<code>SELECT name, birthday, phone_number, COUNT(*) FROM person_info GROUP BY name, birthday, phone_number</code></li>
</ul>
<h2 id="73">7.3 回表的代价</h2>
<p><code>SELECT * FROM person_info WHERE name &gt; 'Asa' AND name &lt; 'Barlow';</code> 这个语句两个特点：</p>
<ul>
<li>会使用到两个 B+ 树索引，一个二级索引，一个聚簇索引。</li>
<li>访问二级索引使用 顺序I/O ，访问聚簇索引使用 随机I/O 。</li>
</ul>
<p>覆盖索引：为了彻底告别 回表 操作带来的性能损耗，我们建议:最好在查询列表里只包含索引列，比如这样:
<code>SELECT name, birthday, phone_number FROM person_info WHERE name &gt; 'Asa' AND name &lt; 'Barlow'</code></p>
<h2 id="74">7.4 如何挑选索引</h2>
<ul>
<li>只为用于搜索、排序或分组的列创建索引。只为出现在 WHERE 子句中的列、连接子句中的连接列，或者出现在 ORDER BY 或 GROUP BY 子句中的列创建索引。</li>
<li>考虑列的基数(值越分散)。 最好为那些列的基数大的列建立索引，为基数 太小列的建立索引效果可能不好。</li>
<li>索引列的类型尽量小 。比较更快，占用更小</li>
<li>索引字符串值的前缀。只对字符串的前几个字符进行索引</li>
<li>让索引列在比较表达式中单独出现。索引列不要加上函数或者表达式，否则索引用不到</li>
<li>主键插入顺序。最好让主键具 有 AUTO_INCREMENT ，让存储引擎自己为表生成主键，而不是我们手动插入。</li>
<li>冗余和重复索引。比如定义了联合索引，又单独定义了一个列索引。</li>
</ul>
<h1 id="8-mysql">第8章 数据的家-MySQL的数据目录</h1>
<h2 id="82-mysql">8.2 MySQL数据目录</h2>
<p><code>SHOW VARIABLES LIKE 'datadir';</code></p>
<h2 id="83">8.3 数据目录的结构</h2>
<p>每个数据库都对应数据目录下的一个子目录，或者说对应一个文件夹，我们每当我们新建一个数据库 时， MySQL 会帮我们做这两件事儿:</p>
<ol>
<li>在 数据目录 下创建一个和数据库名同名的子目录(或者说是文件夹)。</li>
<li>在该与数据库名同名的子目录下创建一个名为 db.opt 的文件，这个文件中包含了该数据库的各种属性，比
  方说该数据库的字符集和比较规则是个啥。</li>
</ol>
<p>表结构信息：InnoDB 和MyISAM 这两种存储引擎都在 数据目录 下对应的数据库子目录下创建了一个专门用于描述表结构的文件。表名.frm</p>
<h4 id="8321-innodb">8.3.2.1 InnoDB是如何存储表数据的</h4>
<ul>
<li>系统表空间(system tablespace):可以对应文件系统上一个或多个实际的文件，默认情况下， InnoDB 会在 数据目录下创建一个名为
ibdata1 (在你的数据目录下找找看有木有)、大小为 12M 的文件，这个文件就是对应的 系统表空 间 在文件系统上的表示</li>
</ul>
<ul>
<li>独立表空间(file-per-table tablespace): mysql5.5.6以后每一个表建立一个独立表空间。 test.ibd(自扩展)，存储 test 表的数据和索引</li>
</ul>
<h4 id="8322-myisam">8.3.2.2 MyISAM是如何存储表数据的</h4>
<p>MyISAM 全部是二级索引，数据和引擎分开。表数据都存放到对应的数据库子目录下。test.frm, test.MYD(数据文件), test.MYI(索引文件)</p>
<h3 id="833">8.3.3 视图在文件系统中的表示</h3>
<p>存储 视图 的时候是不 需要存储真实的数据的，只需要把它的结构存储起来就行了。和 表 一样，
描述视图结构的文件也会被存储到所属数据库对应的子目录下边，只会存储一个 视图名.frm 的文件</p>
<h2 id="85-mysql">8.5 MySQL系统数据库简介</h2>
<ul>
<li>mysql: 存储了MySQL的用户账户和权限信息，一些存储过程、事件的定义信息，一些运行过 程中产生的日志信息，一些帮助信息以及时区信息等</li>
<li>information_schema: MySQL服务器维护的所有其他数据库的信息，比如有哪些表、哪些视图、哪些触发器、哪 些列、哪些索引</li>
<li>performance_schema: 这个数据库里主要保存MySQL服务器运行过程中的一些状态信息，算是对MySQL服务器的一个性能监控</li>
<li>sys: 这个数据库主要是通过视图的形式把 information_schema 和 performance_schema 结合起来，让程序员可以更方便的了解MySQL服务器的一些性能信息。</li>
</ul>
<h1 id="9-9-innodb">9 第9章 存放页面的大池子-InnoDB的表空间</h1>
<h2 id="92">9.2 独立表空间结构</h2>
<h3 id="921-extent">9.2.1 区(extent)的概念</h3>
<p>对于16KB的页来说，<strong>连续</strong>的64个页就是一个 区 ，也就是说一个区默认占用1MB空间大小。不论是系统 表空间还是独立表空间，
都可以看成是由若干个区组成的，每256个区被划分成一组。每个组的最开始的几个页面类型是固定的。</p>
<h3 id="922-segment">9.2.2 段(segment)的概念</h3>
<p>设计 InnoDB 的大叔们对 B+ 树的叶子节点和非叶子节点进行了区别对待，也就是说叶子节点有自己 独有的 区 ，
非叶子节点也有自己独有的 区 。存放叶子节点的区的集合就算是一个 段 ( segment )，存放非叶 子节点的区的集合也算是一个 段 。
也就是说一个索引会生成2个段，一个叶子节点段，一个非叶子节点段。</p>
<p>是碎片区中的页 可以用于不同的目的，比如有些页用于段A，有些页用于段B，有些页甚至哪个段都不属于。碎片区直属于表空 间，
并不属于任何一个段。所以此后为某个段分配存储空间的策略是这样的:</p>
<ul>
<li>在刚开始向表中插入数据的时候，段是从某个碎片区以单个页面为单位来分配存储空间的。</li>
<li>当某个段已经占用了32个碎片区页面之后，就会以完整的区为单位来分配存储空间。</li>
</ul>
<h3 id="923">9.2.3 区的分类</h3>
<p>表空间的是由若干个区组成的，这些区大体上可以分为4种类型:
- 空闲的区:现在还没有用到这个区中的任何页面。
- 有剩余空间的碎片区:表示碎片区中还有可用的页面。
- 没有剩余空间的碎片区:表示碎片区中的所有页面都被使用，没有空闲页面。
- 附属于某个段的区。每一个索引都可以分为叶子节点段和非叶子节点段，除此之外InnoDB还会另外定义一些 特殊作用的段，在这些段中的数据量很大时将使用区来作为基本的分配单位。</p>
<p>综上所述，表空间是由若干个区组成的，每个区都对应一个 XDES Entry 的结构，直属于表空间的区对应的 XDES Entry 结构可以分成
FREE 、 FREE_FRAG 和 FULL_FRAG 这3个链表;每个段可以附属若干个区，每个段中的区对 应的 XDES Entry 结构可以分成
FREE 、 NOT_FULL 和 FULL 这3个链表。每个链表都对应一个 List Base Node 的 结构，这个结构里记录了链表的头、尾节点的位置以及该链表中包含的节点数。
正是因为这些链表的存在，管理 这些区才变成了一件so easy的事情。</p>
<h3 id="924">9.2.4 段的结构</h3>
<p>每个 段都定义了一个 INODE Entry 结构来记录一下段中的属性</p>
<h3 id="925">9.2.5 各类型页面详细情况</h3>
<h3 id="926-segment-header">9.2.6 Segment Header 结构的运用</h3>
<h2 id="93">9.3 系统表空间</h2>
<p>系统表空间的结构和独立表空间基本类似,只不过整个MySQL进程只有一个系统表空间，在系统表空间中会额外记录一些有关整个系统信息的页面，
所以会比独立表空间多出一些记录这些信息的页面</p>
<h1 id="10-10-">10 第10章 条条大路通罗马-单表访问方法</h1>
<h2 id="101-access-method">10.1 访问方法(access method)的概念</h2>
<ul>
<li>全表扫描</li>
<li>使用索引</li>
</ul>
<pre><code class="language-sql"> CREATE TABLE single_table (
        id INT NOT NULL AUTO_INCREMENT,
        key1 VARCHAR(100),
        key2 INT,
        key3 VARCHAR(100),
        key_part1 VARCHAR(100),
        key_part2 VARCHAR(100),
        key_part3 VARCHAR(100),
        common_field VARCHAR(100),
        PRIMARY KEY (id),
        KEY idx_key1 (key1),
        UNIQUE KEY idx_key2 (key2),
        KEY idx_key3 (key3),
        KEY idx_key_part(key_part1, key_part2, key_part3)
) Engine=InnoDB CHARSET=utf8;
</code></pre>
<h2 id="102-const">10.2 const</h2>
<p>把这种通过主键或者<strong>唯一</strong>二级索引列来定位一条记录的访问方法定义为: const (常熟级别的，代价忽略不计)</p>
<h2 id="103-ref">10.3 ref</h2>
<p>这种搜索条件为二级索引列与常数等值比较，采用二级索引来执行查询的访 问方法称为: ref。 （可能匹配多条记录）</p>
<h2 id="104-ref_or_null">10.4 ref_or_null</h2>
<p><code>SELECT * FROM single_demo WHERE key1 = 'abc' OR key1 IS NULL;</code></p>
<h2 id="105-range">10.5 range</h2>
<p>把那种索引列等值匹配的情况称之为 单点区间 ，上边所说的 范围1 和 范围2 都可以被称为单点区间， 像 范围3 这种的我们可以称为连续范围区间。
<code>SELECT * FROM single_table WHERE key2 IN (1438, 6328) OR (key2 &gt;= 38 AND key2 &lt;= 79);</code></p>
<h2 id="106-index">10.6 index</h2>
<p>采用遍历二级索引记录的执行方式称之为: index 。</p>
<p>SELECT key_part1, key_part2, key_part3 FROM single_table WHERE key_part2 = 'abc';</p>
<ul>
<li>查询的三个列都在索引 idx_key_part 中</li>
<li>搜索条件中只有 key_part2，不满足最左前缀(无法用ref或者 range)，但是可以直接遍历二级索引。这种方式称之为 index</li>
</ul>
<h2 id="107-all">10.7 all</h2>
<p>全表扫描, 对于 InnoDB 表来说也就是直接扫描聚簇索引。</p>
<h2 id="108">10.8</h2>
<ul>
<li><strong>一般</strong>情况下只能利用单个二级索引执行查询（如果多个会根据一个查找，回表结果再过滤,因为二级索引只包含索引列和主键）
    - <code>SELECT * FROM single_table WHERE key1 = 'abc' AND key2 &gt; 1000;</code></li>
<li>明确range访问方法使用的范围区间
    - 所有搜索条件都可以使用某个索引的情况: <code>SELECT * FROM single_table WHERE key2 &gt; 100 AND key2 &gt; 200;</code>
    - 有的搜索条件无法使用索引的情况。也就是说一个使用到索引的搜索条件和没 有使用该索引的搜索条件使用 OR 连接起来后是无法使用该索引的。
    - 复杂搜索条件下找出范围匹配的区间。（使用 AND OR 条件简化）</li>
</ul>
<h3 id="1083">10.8.3 索引合并</h3>
<p>特殊情况下也可能在一个查询中使用到多个二级索引，这种使用到多个索引来完成一次查询 的执行方法称之为: index merge.
合并主键之后再回表。</p>
<h4 id="10831-intersection">10.8.3.1 Intersection合并</h4>
<p>(回表是随机IO，读取二级索引是顺序IO)。这种方式场景下会先去合并索引得到的主键 id，之后再回表。有两种情况：
- 二级索引列是等值匹配的情况，对于联合索引来说，在联合索引中的每个列都必须等值匹配，不能出现只出现匹配部分列的情况。
- 主键列可以是范围匹配。只有在这种情况下根据二级索引查询出的结果集是按照主键值排序的</p>
<h4 id="10832-union">10.8.3.2 Union合并</h4>
<ul>
<li>情况一:二级索引列是等值匹配的情况，对于联合索引来说，在联合索引中的每个列都必须等值匹配，不能出现只出现匹配部分列的情况。</li>
<li>情况二:主键列可以是范围匹配</li>
<li>情况三:使用 Intersection 索引合并的搜索条件</li>
</ul>
<h4 id="10833-sort-union">10.8.3.3 Sort-Union合并</h4>
<p>上述这种先按照二级索引记录的主键值进行排序，之后按照 Union 索引合并方式执行的方式称之为 Sort- Union 索引合并，
这种 Sort-Union 索引合并比单纯的 Union 索引合并多了一步对二级索引记录的主键 值排序的过程。</p>
<h1 id="11-11-">11 第11章 两个表的亲密接触-连接的原理</h1>
<h2 id="111">11.1 连接简介</h2>
<p>连接 的本质就是把各个连接表中的记录都取出来依次匹配的组合加入结果集并返回给用户。（笛卡尔积）</p>
<h2 id="112">11.2 连接过程</h2>
<ul>
<li>
<ol>
<li>首先确定第一个需要查询的表，这个表称之为 驱动表</li>
</ol>
</li>
<li>
<ol>
<li>针对上一步骤中从驱动表产生的结果集中的每一条记录，分别需要到 t2 表中查找匹配的记录，所谓 匹配的记录 ，指的是符合过滤条件的记录。</li>
</ol>
</li>
</ul>
<h2 id="1113">11.1.3 内连接和外连接</h2>
<p>驱动表中的记录即使在被驱动表中没有匹配的记 录，也仍然需要加入到结果集。为了解决这个问题，就有了 内连接 和 外连接 的概念</p>
<ul>
<li>对于 内连接 的两个表，驱动表中的记录在被驱动表中找不到匹配的记录，该记录不会加入到最后的结果 集，我们上边提到的连接都是所谓的 内连接 。</li>
<li>对于 外连接 的两个表，驱动表中的记录即使在被驱动表中没有匹配的记录，也仍然需要加入到结果集。又分为左外连接、右外连接</li>
</ul>
<p>过滤条件也分为两种：</p>
<ul>
<li>WHERE 子句中的过滤条件: 不论是内连接还是外连接，凡是不符合 WHERE 子句中的过 滤条件的记录都不会被加入最后的结果集。</li>
<li>ON 子句中的过滤条件:</li>
<li>对于外连接的驱动表的记录来说，如果无法在被驱动表中找到匹配 ON 子句中的过滤条件的记录，那么该记录仍然会被加入到结果集中，对应的被驱动表记录的各个字段使用 NULL 值填充。</li>
<li>内连接中的WHERE子句和ON子句是等价的</li>
</ul>
<p>一般情况下，我们都把只涉及单表的过滤条件放到 WHERE 子句中，把涉及两表的过滤条件都放到 ON 子句中，我 们也一般把放到 ON 子句中的过滤条件也称之为 连接条件</p>
<h4 id="11131">11.1.3.1 左(外)连接的语法</h4>
<p><code>SELECT * FROM t1 LEFT [OUTER] JOIN t2 ON 连接条件 [WHERE 普通过滤条件];</code>
对于 LEFT JOIN 类型的连接来说，我们把放在左边的表称之为外表或 者驱动表，右边的表称之为内表或者被驱动表</p>
<h4 id="11132">11.1.3.2 右(外)连接的语法</h4>
<p>右(外)连接和左(外)连接的原理是一样一样的，语法也只是把 LEFT 换成 RIGHT 而已: <code>SELECT * FROM t1 RIGHT [OUTER] JOIN t2 ON 连接条件 [WHERE 普通过滤条件];</code>
只不过驱动表是右边的表，被驱动表是左边的表。</p>
<h4 id="11133">11.1.3.3 内连接的语法</h4>
<p>内连接和外连接的根本区别就是在驱动表中的记录不符合 ON 子句中的连接条件时不会把该记录加入到最后的结 果集，
<code>SELECT * FROM t1 [INNER | CROSS] JOIN t2 [ON 连接条件] [WHERE 普通过滤条件];</code>
由于在内连接中ON子句和WHERE子句是等价的，所以内连接中不要求强制写明ON子句</p>
<h2 id="112_1">11.2 连接的原理</h2>
<h3 id="1121-nested-loop-join">11.2.1 嵌套循环连接(Nested-Loop Join)</h3>
<p>这种驱动表只访问一次，但被驱动表却可能被多次访问，访问次数取决于 对驱动表执行单表查询后的结果集中的记录条数的连接执行方式称之为 嵌套循环连接 ( Nested-Loop Join )</p>
<h3 id="1122">11.2.2 使用索引加快连接速度</h3>
<p>利用索引加快 被驱动表的查询速度</p>
<h3 id="1123-block-nested-loop-join">11.2.3 基于块的嵌套循环连接(Block Nested-Loop Join)</h3>
<p>join buffer 的概念， join buffer 就是执行连接查询前申请的一块固定大小的内存，
先把若干条驱动表结果集 中的记录装在这个 join buffer 中，然后开始扫描被驱动表，
每一条被驱动表的记录一次性和 join buffer 中的 多条驱动表记录做匹配，因为匹配的过程都是在内存中完成的，所以这样可以显著减少被驱动表的 I/O 代价</p>
<h1 id="12-12-mysql">12 第12章 谁最便宜就选谁-MySQL基于成本的优化</h1>
<h2 id="121">12.1 什么成本</h2>
<ul>
<li>IO 成本。先把数据或者索引加载到内存中然后再操作。这个从磁盘到内存这个加载的过程损耗的时间称 之为 I/O 成本。</li>
<li>CPU 成本。读取以及检测记录是否满足对应的搜索条件、对结果集进行排序等这些操作损耗的时间称之为 CPU 成本。</li>
</ul>
<p>规定读取一个页面花费的 成本默认是 1.0 ，读取以及检测一条记录是否符合搜索条件的成本默认是 0.2 。 1.0 、 0.2 这些数字称之为成本常数</p>
<h2 id="122">12.2 单表查询的成本</h2>
<h3 id="1222">12.2.2 基于成本的优化步骤</h3>
<p>在一条单表查询语句真正执行之前， MySQL 的查询优化器会找出执行该语句所有可能使用的方案，对比之后找出 成本最低的方案，这个成本最低的方案就是所谓的 执行计划 ，之后才会调用存储引擎提供的接口真正的执行查询
1. 根据搜索条件，找出所有可能使用的索引。 possible keys
2. 计算全表扫描的代价。聚簇索引占用的页面数(data_length/16/1024); 该表中的记录数
3. 计算使用不同索引执行查询的代价
4. 对比各种执行方案的代价，找出成本最低的那一个 (根据成本常数计算并且选取最小的代价方式)</p>
<h3 id="1223">12.2.3 基于索引统计数据的成本计算</h3>
<p><code>SHOW VARIABLES LIKE '%dive%';</code> (假设返回200)
说如果我们的 IN 语句中的参数个数小于200个的话，将使用 index dive 的方式计算各个单点区间对应的 记录条数，如果大于或等于200个的话，可就不能使用 index dive 了，要使用所谓的索引统计数据来进行估算</p>
<h2 id="123">12.3 连接查询的成本</h2>
<h3 id="1232-condition-filtering">12.3.2 Condition filtering介绍</h3>
<ul>
<li>单次查询驱动表的成本</li>
<li>多次查询被驱动表的成本(具体查询多少次取决于对驱动表查询的结果集中有多少条记录)</li>
</ul>
<p>我们把对驱动表进行查询后得到的记录条数称之为驱动表的 扇出 (英文名: fanout )。很显然驱动表的扇出值 越小，
对被驱动表的查询次数也就越少，连接查询的总成本也就越低。当查询优化器想计算整个连接查询所使用 的成本时，就需要计算出驱动表的扇出值</p>
<h3 id="1233">12.3.3 两表连接的成本分析</h3>
<p>连接查询总成本 = 单次访问驱动表的成本 + 驱动表扇出数 x 单次访问被驱动表的成本</p>
<ul>
<li>尽量减少驱动表的扇出</li>
<li>对被驱动表的访问成本尽量低(尽量在被驱动表的连接列上建立索引，这样就 可以使用 ref 访问方法来降低访问被驱动表的成本)</li>
</ul>
<h3 id="1234">12.3.4 多表连接的成本分析</h3>
<p>n 个表连接是 n! 种顺序，mysql 会减少计算成本：</p>
<ul>
<li>提前结束某种顺序的成本评估</li>
<li>系统变量 optimizer_search_depth</li>
<li>根据某些规则压根儿就不考虑某些连接顺序</li>
</ul>
<h2 id="124">12.4 调节成本常数</h2>
<p>我们前边之介绍了两个 成本常数, <code>SHOW TABLES FROM mysql LIKE '%cost%'</code> (server层和存储引擎层)
- 读取一个页面花费的成本默认是 1.0
- 检测一条记录是否符合搜索条件的成本默认是 0.2</p>
<h1 id="13-13-innodb">13 第13章 兵马未动，粮草先行-InnoDB统计数据是如何收 集的</h1>
<h2 id="131">13.1 两种不同的统计数据存储方式</h2>
<ul>
<li>永久性的统计数据。这种统计数据存储在磁盘上，也就是服务器重启之后这些统计数据还在。</li>
<li>非永久性的统计数据这种统计数据存储在内存中，当服务器关闭时这些这些统计数据就都被清除掉了，等到服务器重启之后，在
  某些适当的场景下才会重新收集这些统计数据。</li>
</ul>
<h2 id="132">13.2 基于磁盘的永久性统计数据</h2>
<p><code>SHOW TABLES FROM mysql LIKE 'innodb%';</code></p>
<h1 id="1323">13.2.3 定期更新统计数据 (以表为单位)</h1>
<p>innodb_table_stats 和 innodb_index_stats 表里的统计数据是不是也应该跟着变一变了?当然要变了, 提供了如下两种更新统计数据的方式:</p>
<ul>
<li>开启 innodb_stats_auto_recalc。每个表都维护了一个变量，该变量记录着对该表进行增删改的记录条数，如果发生变动的记录数量超过了表大小的 10% ，
  并且自动重新计算统计数据的功能是打开的，那么服务器会重新进行一 次统计数据的计算，并且更新 innodb_table_stats 和 innodb_index_stats 表</li>
<li>手动调用 ANALYZE TABLE 语句来更新统计信息(同步的)</li>
</ul>
<h2 id="133">13.3 基于内存的非永久性统计数据</h2>
<h1 id="14-14-mysql">14 第14章 不好看就要多整容-MySQL基于规则的优化(内 含关于子查询优化二三事儿)</h1>
<h2 id="141">14.1 条件化简</h2>
<ul>
<li>移除不必要的括号</li>
<li>常量传递(constant_propagation): <code>a=5 and b&gt;a</code> -&gt; <code>a=5 and b&gt;5</code></li>
<li>等值传递(equality_propagation)</li>
<li>移除没用的条件(trivial_condition_removal)。永远True 或者 False 的表达式</li>
<li>表达式计算</li>
<li>HAVING子句和WHERE子句的合并</li>
<li>常量表检测</li>
</ul>
<h2 id="142">14.2 外连接消除</h2>
<p>外连接查询中，指定的 WHERE 子句中包含被驱动表中的列不为 NULL 值的条件称之为 空值拒绝 (英文名: reject-NULL )。
在被驱动表的WHERE子句符合空值拒绝的条件后，外连接和内连接可以相互转 换。这种转换带来的好处就是查询优化器可以通过评估表的不同连接顺序的成本，选出成本最低的那种连接顺序 来执行查询。</p>
<h2 id="143">14.3 子查询优化</h2>
<h3 id="1432-mysqlmysql-57">14.3.2 子查询在MySQL中是怎么执行的(MySQL 5.7)</h3>
<p>对于包含不相关的标量子查询或者行子查询的查询语句来说，MySQL会分别独立的执行外层查询和子 查询，就当作两个单表查询就好了</p>
<p>将子查询结果集中的记录保存到临时表的过程称之为 物化 (英文名: Materialize )。</p>
<p>半连接 (英文名: semi-join )。将 s1 表和 s2 表进行半连接的意思就是:对于 s1 表的某 条记录来说，我们只关心在 s2 表中是否存在与之匹配的记录是否存在，而不关心具体有多少条记录与之匹配， 最终的结果集中只保留 s1 表的记录</p>
<h1 id="15-15-explain">15 第15章 查询优化的百科全书-Explain详解(上)</h1>
<p>MySQL 查询优化器的各种基于成本和规则的优化会后生成一个所谓的 执行计划 ，这个执行 计划展示了接下来具体执行查询的方式，
比如多表连接的顺序是什么，对于每个表采用什么访问方法来具体执行 查询等等。 EXPLAIN 语句来帮助我们查看某个查询语句的具体执行计划</p>
<pre><code class="language-sql">MySQL [(none)]&gt; explain select 1;
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra          |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------+
|  1 | SIMPLE      | NULL  | NULL       | NULL | NULL          | NULL | NULL    | NULL | NULL |     NULL | No tables used |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------+
</code></pre>
<h2 id="151">15.1 执行计划输出中各列详解</h2>
<ul>
<li>table: 表名。EXPLAIN语句输出的每条记录都对应着某个单表的访问方法，该条记录的table列代表着该表的表名</li>
<li>id: 查询语句中每出现一个 SELECT 关键字，设计 MySQL 的大叔就会为它分配一个唯一的 id 值</li>
<li>select_type: SIMPLE, PRIMARY, UNION, UNION RESULT, DEPENDENT SUBQUERY, DEPENDENT UNION, DERIVED, MATERIALIZED</li>
<li>type: (一般按照以下顺序性能依次变差)
    - system: 当表中只有一条记录并且该表使用的存储引擎的统计数据是精确的，比如MyISAM、Memory，那么对该表的 访问方法就是 system
    - const: 根据主键或者唯一二级索引列与常数进行等值匹配时，对单表的访问方法 就是 const
    - eq_ref: 在连接查询时，如果被驱动表是通过主键或者唯一二级索引列等值匹配的方式进行访问的(如果该主键或者唯一二级索引是联合索引的话，所有的索引列都必须进行等值比较)，则对该被驱动表的访问方法就是eq_ref
    - ref: 当通过普通的二级索引列与常量进行等值匹配时来查询某个表，那么对该表的访问方法就可能是 ref
    - fulltext
    - ref_or_null: 对普通二级索引进行等值匹配查询，该索引列的值也可以是 NULL 值时，那么对该表的访问方法就可能是 ref_or_null
    - index_merge: Intersection 、 Union 、 Sort-Union 这三种索引合并的方式来执行查询
    - unique_subquery: 子查询可以使用到主键进行等值匹配的 话，那么该子查询执行计划的 type 列的值就是 unique_subquery
    - index_subquery: index_subquery 与 unique_subquery 类似，只不过访问子查询中的表时使用的是普通的索引
    - range: 使用索引获取某些 范围区间 的记录，那么就可能使用到 range 访问方法
    - index: 当我们可以使用索引覆盖，但需要扫描全部的索引记录时，该表的访问方法就是 index
    - ALL: 全表扫描 (除了ALL其他都可以利用索引，除了index_merge 其余最多只能利用一个索引)</li>
<li>possible_keys: 可能用到的索引(并非越多越好，删除无用索引)</li>
<li>keys: 实际用到的索引(查询优化器计算后的选择)</li>
<li>key_len: 当优化器决定使用某个索引执行查询时，该索引记录的最大长度</li>
<li>ref: 当使用索引列等值匹配的条件去执行查询时，也就是在访问方法是 const 、 eq_ref 、 ref 、 ref_or_null 、 unique_subquery 、 index_subquery 其中之一时， ref 列展示的就是与索引列作等值匹配的对象</li>
<li>rows: 优化器决定使用全表扫描的方式对某个表执行查询时，rows 列就代表预计需要扫描的行数，如果使用索引来执行查询时，执行计划的 rows 列就代表预计扫描的索引记录行数</li>
<li>filtered: 连接查询中用来计算扇出值</li>
<li>Extra:额外信息。 No tables used; Impossible WHERE; No matching min/max row; Using index; Using index condition
    - Using index condition(索引下推 Index Condition Pushdown):  <code>SELECT * FROM s1 WHERE key1 &gt; 'z' AND key1 LIKE '%a';</code>
        - 先根据 <code>key1&gt;z</code>定位到二级索引记录，然后先不着急回表而是检测记录是否满足 <code>key1 like '%a'</code>，不满足都没必要回表(随机IO)
    - Using where: 当我们使用全表扫描来执行对某个表的查询，并且该语句的 WHERE 子句中有针对该表的搜索条件时
    - Using join buffer (Block Nested Loop)
    - Not exists
    - Using intersect(...) 、 Using union(...) 和 Using sort_union(...)
    - Zero limit: limit 参数 0
    - Using filesort: 在内存中或者磁盘上进行排序的方式统称为文件排序( 大量文件排序很消耗性能 )
    - Using temporary: 使用了临时内部表
    - Start temporary, End temporary
    - LooseScan
    - FirstMatch</li>
</ul>
<h1 id="16-16-explain">16 第16章 查询优化的百科全书-Explain详解(下)</h1>
<h2 id="162-json">16.2 Json格式的执行计划</h2>
<pre><code>mysql&gt; EXPLAIN FORMAT=JSON SELECT * FROM s1 INNER JOIN s2 ON s1.key1 = s2.key2 WHERE s1.common_field = 'a'\G
</code></pre>
<h2 id="163-extented-explain">16.3 Extented EXPLAIN</h2>
<p>使用 EXPLAIN 语句查看了某个查询的执行计划后，紧接着 还可以使用 SHOW WARNINGS 语句查看与这个查询的执行计划有关的一些扩展信息</p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
