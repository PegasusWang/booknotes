# 02 到底怎么理解“平均负载”?

uptime 最后三个数字分别表示 1、5、15 分钟得平均负载(load average)。

平均负载：单位时间内，系统处于可运行状态和不可中断状态的平均进程数。(简单理解就是活跃进程数)
当平均负载比 cpu 个数大的时候，系统已经出现了过载。当平均负载高于cpu数量 70%的时候，就应该分析排查负载高的问题了。

平均负载高可能是cpu密集型进程导致的；也不一定代表cpu使用率高，也可能是 IO 更加繁忙了。

- stress linux 系统压力测试工具
- sysstat 包含了 mpstat (多和cpu性能分析工具) 和 pidstat(进程性能分析工具)


# 03 CPU 上下文切换什么意思
cpu 上下文： CPU 寄存器和程序计数器

- 进程上下文切换。进程调度的时候
- 线程上下文切换。线程是调度的基本单位，进程是资源拥有的基本单位。同进程内的线程切换消耗更少资源
- 中断上下文切换。中断会打断进程的正常调度和执行，转而调用中断处理程序，相应设备事件。不涉及到用户态


# 04 经常说的 cpu 上下文切换什么意思？

过多的上下⽂切换，会把 CPU 时间消耗在寄存器、内核栈以及虚拟内存等数据的保存和恢复上，缩短进程真正运⾏的时间，成了系统性能⼤幅下降的⼀个元凶。

使用vmstat 查询上下文切换情况。

```
❯ vmstat 5 # 每隔5s输出一次数据
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 6880312 548160 6785520    0    0    19    14    1    0  2  1 97  0  0
```

- cs(context switch) 每秒上下文切换次数
- in(interrupt)每秒中断次数
- r(running or runnable) 就绪队列长度，正在运行和等待 cpu 的进程数
- b(blocked) 处于不可中断睡眠状态的进程数

使用 pidstat -w 查看每个进程的上下文切换情况

- 所谓⾃愿上下⽂切换，是指进程⽆法获取所需资源，导致的上下⽂切换。⽐如说， I/O、内存等系统资源不⾜时，就会发⽣⾃愿上下⽂切换。
- ⽽⾮⾃愿上下⽂切换，则是指进程由于时间⽚已到等原因，被系统强制调度，进⽽发⽣的上下⽂切换。⽐如说，⼤量进程都在争抢 CPU 时，就容易发⽣⾮⾃愿上下⽂切换。

sysbench 多线程基准测试工具， 模拟上线文切换过多场景。

每秒上下文切换多少次正常？

这个数值其实取决于系统本身的 CPU 性能。在我看来，如果系统的上下⽂切换次数⽐较稳定，那么
从数百到⼀万以内，都应该算是正常的。但当上下⽂切换次数超过⼀万次，或者切换次数出现数量级的增⻓时，就很可能已经出现了性能问题。

这时，你还需要根据上下⽂切换的类型，再做具体分析。⽐⽅说：

- ⾃愿上下⽂切换变多了，说明进程都在等待资源，有可能发⽣了 I/O 等其他问题；
- ⾮⾃愿上下⽂切换变多了，说明进程都在被强制调度，也就是都在争抢 CPU，说明 CPU 的确成了瓶颈；
- 中断次数变多了，说明 CPU 被中断处理程序占⽤，还需要通过查看 /proc/interrupts ⽂件来分析具体的中断类型。


# 05 某个应用 cpu 使用率 100%，该怎么办？

除了空闲时间之外的其他时间占总 CPU 时间的百分比。性能分析工具一般给出的是一段时间的平均 cpu 使用率，注意时间间隔的设置。
多个工具对比保证时间间隔一致。

- top : 默认显示的是所有 cpu 的平均值
- pidstat: 每个进程 cpu 使用率情况
- ps :  每个进程资源使用

使用 perf 分析 cpu 性能问题

- perf top 可以实时显示占用 cpu 时钟最多的函数或者指令，可以用来查找热点函数
- perf record 记录，perf report 解析展示。
- perf 加上参数-g 开启调用关系的采样
- `perf top -g -p pid`
