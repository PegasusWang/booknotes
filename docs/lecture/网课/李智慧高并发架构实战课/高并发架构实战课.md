# 01 软件建模与文档 ：架构师怎样绘制系统架构蓝图？

常用 UML图：

- 类图: 类的特性和类之间的静态关系(关联、依赖、继承、组合、聚合、泛华)
- 时序图: 参与者之间的动态调用关系
- 组件图: 比类粒度更大的设计元素，一个组件中包含多个类
- 部署图：部署情况，需要多少服务器，关键服务部署在哪些服务器上
- 用例图：用户和软件系统交互，描述功能需求
- 状态图：单个对象生命周期状态变迁
- 活动图：过程逻辑和业务流程


# 02 高并发架构设计方法：如何对症下药？
高并发方法论：垂直伸缩与水平伸缩。

- 分布式应用。负载均衡器
- 分布式缓存。
- 分布式消息队列。解决突发的高并发写操作问题和实现更简单的集群伸缩
- 分布式关系数据库
- 分布式微服务

系统并发并发指标：

- 目标用户数
- 系统用户数
- 活跃用户数
- 在线用户数
- 并发用户数


# 03 短 URL 生成器设计：百亿短URL 怎么做到无冲突
算法：

- 单项散列函数。md5或者SHA256等生成得到128bit或者256bit 的 hash 值，然后 base64 编码取前面 6 个。
  - 可能冲突。需要修改算法或者截断位置，可能需要多次查找。有性能问题

- 自增长短URL。维持一个自增长的二进制自然数，然后进行Base64编码。 不过会被遍历，可以预测
- 预生成短URL。随机数生成，通过布隆过滤器检查是否存在。

设计要点：

- 高可用：应用服务器、文件服务器、数据库采用集群部署
- 高性能：缓存。miss 的数据通过 HBase 获取(10ms)

详细设计：

- 重定向响应码：302 可以统计使用情况
- 短 URLyu生成文件和预加载：写打开偏移量文件 -> 读偏移量 -> 读打开短URL文件 -> 从偏移量开始读取60K数据 -> 关闭短URL文件 -> 修改偏移量文件 -> 关闭偏移量文件。
- 修改Base64编码表。去掉 `+/` 被转义字符换成 `-_`


# 04 网页爬虫设计：如何下载千亿级网页？

非功能需求:

- 伸缩性：分布式爬虫
- 健壮性：应对各种网页异常
- 去重
- 扩展性

设计要点：

- 知名网站作为种子 URL。
- HDFS 存储
- 调度器和下载器
- 分布式爬虫

详细设计：

- URL调度器算法。广度优先实现简单，且网页有关联性。域名优先级，多个队列选择优先级
- 去重：布隆过滤器。 提取网站关键内容计算 MD5 用于去重
- 高可用：调度后者下载器宕机(redis记录运行状态)； 下载器多线程互不影响


# 05 网盘系统设计：万亿 GB 网盘如何实现秒传和限速？

功能需求：文件上传、下载；断点续传；共享文件；流速控制

非功能需求：

- 大数据量存储。 10亿用户，1000 亿文件，月一亿TB
- 高并发访问
- 大流量负载
- 高可靠存储
- 高可用服务
- 数据安全性
- 不重复上传(秒传)

概要设计：

- 元数据和文件分开存储与管理。大文件切分 block，再分别上传存储。选择 Ceph 作为对象存储

详细设计：

- 元数据库设计。分片的关系数据库存储
  - User表：user_id, user_name, create_time, user_type, userd_space
  - File表：file_id, file_name, is_directory, parent_file_id, md5, create_time, size, user_id, is_shared
  - Block: block_id, md5, file_id

- 限速：API 返回能够同时上传、下载的 BLOCK 数量和传输速度，对不同用户限速
- 秒传：只有文件长度、开头256KB的md5、文件的md5 三个值都相同，才认为文件相同，文件小于256KB直接上传，不启用秒传。


# 06 短视频系统设计：如何支持三千万用户同时在线看视频

需求分析：上传、搜索、观看视频

详细设计: 

- 视频存储系统。 HDFS，存储细节记录到 HBase。
- 性能优化与 CDN 设计：粉丝超10 万的主动推送 CDN，提高命中率（计算完播率推送部分 chunk）
- 缩略图生成与推荐设计。大数据平台的机器学习引擎


# 07 海量数据处理技术回顾：CAP 难题

- HDFS (存储海量文件数据)
- 分布式关系数据库
- HBase
- ZooKeeper
- 布隆过滤器


# 08 秒杀系统设计

核心问题：

- 独立部署
- 百倍的高并发访问压力
- 防止用户跳过秒杀页面

概要设计：

- 网页简单；按钮置灰
- 流量控制：多级缓存。CDN 缓存
- 秒杀开始再推送 js 文件。包含开启标志和随机参数


# 09 交友系统设计：哪种地理空间邻近算法更快

- 用户微服务
- 图片微服务
- 配对微服务
- 推荐微服务

常用算法：

- SQL 邻近算法。`select * from users where latitude between X-D and X+D and longitude between Y-D and Y+D;` sql 压力较大，废弃
- 地理网格邻近算法。
- 动态网格算法(4叉树网格)
- GeoHash算法。 redis geohash


# 10 搜索引擎设计

分布式爬虫、索引构造器、网页排名算法、搜索器

详细设计：

- 索引。索引构造器从 HDFS 读取网页内容，解析页面并提取单词
- PageRank 排名算法


# 11 反应式编程框架设计：如何使方法调用无阻塞等待？


# 12 高性能架构三板斧：分析系统性能问题从哪里入手?

- 响应时间
- 并发数
- 吞吐量

性能测试：

- 性能测试: 预期性能目标
- 负载测试：安全临界值
- 压力测试：超过安全负载

三板斧：

- 分布式集群扩展降低单一服务器压力(负载均衡)；链路层负载均衡
- 缓存降低读取压力(缓存)；CDN、反向代理、分布式对象缓存
- 消息队列降低写压力(消息队列)


# 13 微博系统设计：怎么应对热点事件的突发访问压力？

需求：发微博、关注好友、刷微博

详细设计：

- 微博的发表/订阅。推拉结合
- 缓存使用策略: redis缓存所有用户 7 天内发的微博；本机缓存拥有百万以上关注者 24 小时发表的微博
- 数据库分片策略：用户 id or 微博 id


# 14 百科应用系统设计：机房被火烧了系统还能访问么

GeoDNS, CDN, LVS, Nginx, Lighttpd, Redis, Elsaticsearch。

写请求转发到主数据中心。

详细设计：

- 前端性能优化。 DNS、CDN、反向代理、静态资源服务
- 服务端性能优化； APC(php字节码缓存); Tex(文本格式化)；替换 php strstr()
- 存储端性能优化：热点本地缓存；尽可能直接缓存文本格式，避免构造数据的代价；使用缓存服务器存储 sessin 对象
- 数据库：较大的服务器内存；RAID5 磁盘阵列加速磁盘访问；主主复制和主从复制，保证写入高可用，并将负载分散多个服务器

Alibaba otter 实现异地双活。


# 15 限流器设计 : 如何避免超预期的高并发压力压垮系统？

限流方式：全局限流；账号限流；设备限流；资源限流；

概要设计：

- 限流模式。本地限流和远程限流(分布式限流，存储在 redis)
- 降级：配置中心不可用，降级为本地配置; redis 不可用，降级为本地限流

详细设计：

- 配置文件设计(优先令牌桶)

```yaml
URl: /
rules:
  - actor: device # 限流对象(账号actor, 设备device, 全部all)
  - unit: second
  - rpu: 10 # request per unit
  - scope: global # 生效范围 本地local, 全局global
  - algo: TB # window, sliding window, leaky bucket, token bucket

```


# 16 高可用架构十种武器: 怎么度量系统可用性？

| 可用性指标 | 可用性程度               | 年度不可用时间 |
|------------|--------------------------|----------------|
| 99%        | 基本可用                 | 88小时         |
| 99.9%      | 较高可用                 | 9小时          |
| 99.99%     | 具有自动恢复能力的高可用 | 53分钟         |
| 99.999%    | 极高的可用性             | 5分钟          |

- 解耦
  - 组件的低耦合原则：无循环依赖原则；稳定依赖原则(被依赖组件尽量稳定)；稳定抽象原则
  - 面向对象的低耦合原则：开闭原则；依赖倒置原则；接口隔离原则

- 隔离。微服务
- 异步。消息队列
- 备份。备份与失效转移(failover)
- 重试。修复单次调用故障(必须是幂等才可重试)
- 熔断。断路器
- 补偿。分布式事务补偿机制
- 限流。
- 降级。非核心功能降级
- 多活。异地多活

高可用运维方案：

- 自动化测试减少系统 bug 
- 自动化监控尽早发现故障
- 预发布环境发现测试环境无法发现的 bug
- 通过灰度发布降低软件错误带来的影响


# 17 Web 应用防火墙：怎样拦截恶意用户的非法请求

Web Application Firewall, WAF。

- 跨站点脚本攻击
- SQL注入
- 跨站点请求伪造
- 注释与异常信息泄露


# 18 加解密服务平台：如让敏感数据存储与传输更加安全

需求：

- 安全性。一个秘钥至少拆成两片，分别存储在两个异构、物理隔离的存储服务器中
- 可靠性
- 性能


# 19 许可型区块链重构：无中心的区块链怎么做到可信任？


# 20 网约车系统设计

详细设计：

- 长连接管理。TCP管理服务器集群
- 距离计算。redis GeoHash
- 派单算法。行驶距离代替空间距离。订单聚合池，订单聚合桶
- 订单状态模型。状态转换和终止状态


# 21 网约车系统重构：如何用 DDD 重构网约车系统设计？

领域驱动设计就是从领域出发，分析领域内模型及其关系，进而设计软件系统的方法。
通常做法是把整个领域拆分成多个子域，比如用户、商品、订单、库存、物流、发票等。强相关的多个子域组成一个限界上下文，
它是对业务领域范围的描述，对于系统实现而言，限界上下文相当于是一个子系统或者一个模块。
限界上下文和子域共同组成组织的领域。

领域模型对象也被称为实体。先通过业务分析，识别出实体对象，然后通过相关业务逻辑，设计实体的属性和方法。
而限界上下文和上下文映射图则是微服务设计的关键，通常实践中，限界上下文被设计为微服务，而上下文映射图就是微服务之间的依赖
关系。

DDD重构路线图:

1. 讨论当前系统存在的问题，发现问题背后的根源。比如：架构与代码混乱，需求迭代困难，部署麻烦，bug率逐渐升高；微服务边界不清晰，调用依赖关系复杂，团队职责混乱。
2. 针对问题分析具体原因。比如：微服务 A 太庞大，微服务B和C职责不清，团队内业务理解不一致，内部代码设计不良，硬编码和耦合太多。
3. 重新梳理业务流程，明确业务术语，进行DDD战略设计，具体又可以分为三步。- a. 进行头脑风暴，分析业务现状和期望，构建领域语言；- b. 画泳道活动图、结合团队特性设计限界上下文；- c. 根据架构方案和非功能需求确定微服务设计。
4. 针对当前系统实现和DDD设计不匹配的地方，设计微服务重构方案。比如：哪些微服务需要重新开发，哪些微服务的功能需要从A调整到B，哪些微服务需要分拆。
5. DDD技术验证。针对比较重要、问题比较多的微服务进行重构打样，设计聚合根、实体、值对象，重构关键代码，验证设计是否合理以及团队能否驾驭DDD。
6. 任务分解与持续重构。在尽量不影响业务迭代的前提下，按照重构方案，将重构开发和业务迭代有机融合。


# 22 大数据平台设计：如何用数据为用户创造价值

# 结束语

架构师最核心的事情是要控制技术局面，让事情有节奏推进，不要鸡毛蒜皮，做决策的人越是忙忙碌碌，团队效率越低。
