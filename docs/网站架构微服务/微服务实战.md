# 1. 微服务的设计与运行

微服务五大核心原则：自治性、可恢复性、透明性、自动化和一致性。


# 2. SimpleBank 公司微服务

用了一个虚拟的公司业务来讲解微服务。帮助用户进行投资管理。

收集微服务业务指标、日志以及服务间的链路跟踪记录对于微服务应用当前和过去的运行表现是至关重要的。


# 3. 微服务应用的架构

微服务应用由四层组成：平台层、服务层、边界层和客户端层。

常见的边界层模式有 API 网关和消费者驱动的网关（GraphQL）。

# 4. 新功能设计

良好的服务三大特性：单一职责、可独立部署、可替换。

三种服务划分策略：

- 按照业务能力和限界上下文(有着清晰范围和明确外部边界的内聚单元)划分-服务相对粗粒度但是又紧密团结成一个整体的业务功能领域
- 用例划分。系统中将要发生的动作
- 易变性。未来可能变化的领域封装在内部

以 SimpleBank 为例：

- 用户管理服务
- 资产信息服务
- 投资策略服务

建议由内之外地设计微服务，在构建面向操作的细粒度的服务之前，先开发粗粒度功能。
不太好确定边界的时候，先开发大一点的服务。避免过早分解省下时间完善对问题域的了解

代码开放化、接口明确化、沟通持续化、放宽 DRY 原则的要求，可以缓解团队之间的紧张关系。

# 5. 微服务的事务与查询

# 5.1 分布式应用的事务一致性

2pc 之类的分布式事务会降低可用性

# 5.2 基于事件的通信

不建议分布式事务，使用 事件和编排

# 5.3 Saga

Saga 是一组互相协作的本地事务序列，每一步操作都由前一步骤触发。
saga中会使用补偿撤销之前的操作，并让系统恢复到更一致的状态，但是不保证恢复最初状态。

常用的一致性策略：

- 补偿：撤销之前的操作
- 充实：反复重试直到成功或者超时
- 忽略：什么都不做
- 重启：恢复到最初状态，然后重新开始执行
- 临时：执行一个临时操作，稍后确认或者取消

# 5.4 分布式世界中的查询操作

- 通过 API 组合，批量查询。
- 保存数据副本。存储成本，缓存失效
- 查询和命令分离
  - 乐观更新。比如用户 点赞之后客户端先假显。
  - 轮询。一直到版本号大于当前这个版本号
  - 发布订阅

# 6. 设计高可靠服务
